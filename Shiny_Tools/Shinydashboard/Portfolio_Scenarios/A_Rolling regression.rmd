---
title: "Untitled"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and Microsoft Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **R Tools | Publish | Preview** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
summary(cars)
```

You can also embed plots, for example:

```{r, echo=FALSE}
#Example 6: Use zoo rollapply to visualize a rolling regression


Quotes2pairs <- subset(Quotes, symbol == "SIE.DE" | symbol == "CBK.DE")


#not working
#stock_pairs <- Quotes2pairs %>%
stock_prices <- c("SIE.DE", "CBK.DE") %>%
    tq_get(get = "stock.prices",
           from = "2015-01-01",
           to = "2016-12-31") %>%
           group_by(symbol)

stock_pairs <- stock_prices %>%
    tq_transmute(select = adjusted,
                 mutate_fun = periodReturn,
                 period = "daily",
                 type = "log",
                 col_rename = "returns") %>%
                 spread(key = symbol, value = returns)

stock_pairs %>%
    ggplot(aes(x = SIE.DE, y = CBK.DE)) +
    geom_point(color = palette_light()[[1]], alpha = 0.5) +
    geom_smooth(method = "lm") +
    labs(title = "Visualizing Returns Relationship of Stock Pairs") +
    theme_tq()



Instrument1 = "SIE.DE"
Instrument2 = "CBK.DE"

lm(Instrument1 ~ Instrument2, data = stock_pairs) %>%
    summary()


#While this characterizes the overall relationship, it ’s missing the time aspect. Fortunately, we can use the rollapply function from the zoo package to plot a rolling regression, showing how the model coefficent varies on a rolling basis over time. We calculate rolling regressions with tq_mutate() in two additional steps:
#    Create a custom function
#Apply the function with tq_mutate(mutate_fun = rollapply)

regr_fun <- function(data) {
    coef(lm(Instrument1 ~ Instrument2, data = timetk::tk_tbl(data, silent = TRUE)))
}


stock_pairs <- stock_pairs %>%
         tq_mutate(mutate_fun = rollapply,
                   width = 90,
                   FUN = regr_fun,
                   by.column = FALSE,
                   col_rename = c("coef.0", "coef.1"))
stock_pairs

stock_pairs %>%
    ggplot(aes(x = date, y = coef.1)) +
    geom_line(size = 1, color = palette_light()[[1]]) +
    geom_hline(yintercept = 0.8134, size = 1, color = palette_light()[[2]]) +
    labs(title = "MA ~ V: Visualizing Rolling Regression Coefficient", x = "") +
    theme_tq()


stock_prices %>%
    tq_transmute(adjusted,
                 periodReturn,
                 period = "daily",
                 type = "log",
                 col_rename = "returns") %>%
                 mutate(wealth.index = 100 * cumprod(1 + returns)) %>%
                 ggplot(aes(x = date, y = wealth.index, color = symbol)) +
                 geom_line(size = 1) +
                 labs(title = "MA and V: Stock Prices") +
                 theme_tq() +
                 scale_color_tq()

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
